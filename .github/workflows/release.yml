name: Release GitBar

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: macos-14
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/v}
          echo "version=$TAG" >> $GITHUB_OUTPUT
          echo "tag=$GITHUB_REF_NAME" >> $GITHUB_OUTPUT

      - name: Update Info.plist version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" GitBar/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $VERSION" GitBar/Info.plist
          echo "Updated Info.plist to version $VERSION"

      - name: Import signing certificate
        env:
          CERTIFICATE_BASE64: ${{ secrets.CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        run: |
          echo "Importing Developer ID certificate..."
          echo "$CERTIFICATE_BASE64" | base64 --decode > certificate.p12

          # Create temporary keychain
          security create-keychain -p actions temp.keychain
          security default-keychain -s temp.keychain
          security unlock-keychain -p actions temp.keychain
          security set-keychain-settings -lut 21600 temp.keychain

          # Import certificate
          security import certificate.p12 -k temp.keychain \
            -P "$CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/productsign

          # Allow codesign to access keychain
          security set-key-partition-list -S apple-tool:,apple: \
            -s -k actions temp.keychain

          # Clean up certificate file
          rm certificate.p12

          # Verify certificate
          security find-identity -v -p codesigning temp.keychain

      - name: Build and archive
        run: |
          xcodebuild -project GitBar.xcodeproj \
            -scheme GitBar \
            -configuration Release \
            -archivePath ./build/GitBar.xcarchive \
            ENABLE_HARDENED_RUNTIME=YES \
            CODE_SIGN_INJECT_BASE_ENTITLEMENTS=NO \
            OTHER_CODE_SIGN_FLAGS="--timestamp --options=runtime" \
            archive

      - name: Create export options
        env:
          TEAM_ID: ${{ secrets.TEAM_ID }}
        run: |
          cat > build/ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>developer-id</string>
              <key>teamID</key>
              <string>${TEAM_ID}</string>
              <key>signingStyle</key>
              <string>automatic</string>
              <key>stripSwiftSymbols</key>
              <true/>
          </dict>
          </plist>
          EOF

      - name: Export signed app
        run: |
          xcodebuild -exportArchive \
            -archivePath ./build/GitBar.xcarchive \
            -exportPath ./build \
            -exportOptionsPlist ./build/ExportOptions.plist

      - name: Verify code signature
        run: |
          echo "Verifying code signature..."
          codesign --verify --deep --strict --verbose=2 ./build/GitBar.app
          codesign -dv --verbose=4 ./build/GitBar.app

          echo "Checking for hardened runtime..."
          codesign -dv --verbose=4 ./build/GitBar.app 2>&1 | grep -q "runtime" || (echo "ERROR: Hardened runtime not enabled!" && exit 1)
          echo "âœ“ Hardened runtime enabled"

      # TODO: Re-enable notarization once CI timeout issues are resolved
      # The notarization step was hanging indefinitely in GitHub Actions.
      # See: https://github.com/burhanusman/gitbar/issues/XXX (create tracking issue)
      #
      # - name: Setup notarization credentials
      #   env:
      #     APP_STORE_CONNECT_API_KEY_P8: ${{ secrets.APP_STORE_CONNECT_API_KEY_P8 }}
      #   run: |
      #     echo "Setting up App Store Connect API key..."
      #     echo "$APP_STORE_CONNECT_API_KEY_P8" > /tmp/api-key.p8
      #     chmod 600 /tmp/api-key.p8
      #
      # - name: Notarize app bundle
      #   env:
      #     APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
      #     APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      #   run: |
      #     echo "Creating zip for notarization..."
      #     cd build
      #     zip -r GitBar-notarize.zip GitBar.app
      #
      #     echo "Submitting for notarization..."
      #     xcrun notarytool submit GitBar-notarize.zip \
      #       --key /tmp/api-key.p8 \
      #       --key-id "$APP_STORE_CONNECT_KEY_ID" \
      #       --issuer "$APP_STORE_CONNECT_ISSUER_ID" \
      #       --wait
      #
      #     echo "Stapling notarization ticket..."
      #     xcrun stapler staple GitBar.app
      #
      #     echo "Verifying notarization..."
      #     spctl --assess --verbose=4 --type execute GitBar.app
      #
      #     rm GitBar-notarize.zip

      - name: Install dmgbuild
        run: |
          # Install dmgbuild via pipx (works reliably in CI, no AppleScript needed)
          brew install pipx
          pipx install dmgbuild
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Create DMG
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          chmod +x scripts/create-dmg-v2.sh

          # Set paths for dmgbuild settings
          export APP_PATH="build/GitBar.app"
          export DMG_RESOURCES="dmg-resources"
          export PATH="$HOME/.local/bin:$PATH"

          ./scripts/create-dmg-v2.sh build/GitBar.app build

          # Verify DMG was created with expected name
          DMG_PATH="build/GitBar-v${VERSION}.dmg"
          if [ ! -f "$DMG_PATH" ]; then
            echo "Expected DMG not found at $DMG_PATH"
            echo "Looking for DMG files in build/:"
            ls -la build/*.dmg 2>/dev/null || echo "No DMG files found!"
            # Try to find any DMG and rename it
            FOUND_DMG=$(ls build/*.dmg 2>/dev/null | head -1)
            if [ -n "$FOUND_DMG" ]; then
              echo "Found DMG: $FOUND_DMG - renaming to $DMG_PATH"
              mv "$FOUND_DMG" "$DMG_PATH"
            else
              exit 1
            fi
          fi
          echo "DMG ready: $DMG_PATH"

      - name: Sign DMG
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DMG_PATH="build/GitBar-v${VERSION}.dmg"

          echo "Signing DMG..."
          codesign --sign "Developer ID Application" --timestamp "$DMG_PATH"

          echo "Verifying DMG signature..."
          codesign --verify --verbose=2 "$DMG_PATH"

          # TODO: Re-enable DMG notarization once CI timeout issues are resolved
          # echo "Submitting DMG for notarization..."
          # xcrun notarytool submit "$DMG_PATH" \
          #   --key /tmp/api-key.p8 \
          #   --key-id "$APP_STORE_CONNECT_KEY_ID" \
          #   --issuer "$APP_STORE_CONNECT_ISSUER_ID" \
          #   --wait
          #
          # echo "Stapling notarization ticket to DMG..."
          # xcrun stapler staple "$DMG_PATH"

      # TODO: Re-enable when Sparkle signing is fixed
      # - name: Download Sparkle tools
      #   run: |
      #     echo "Downloading Sparkle..."
      #     curl -L -o Sparkle.tar.xz \
      #       https://github.com/sparkle-project/Sparkle/releases/download/2.6.4/Sparkle-2.6.4.tar.xz
      #     tar -xf Sparkle.tar.xz
      #     chmod +x bin/generate_appcast

      - name: Create distribution archive for Sparkle
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd build
          # Create zip from the notarized app
          zip -r GitBar.zip GitBar.app
          mv GitBar.zip "GitBar-v${VERSION}.zip"

      # TODO: Re-enable Sparkle signing once key issues are resolved
      # The generate_appcast tool was rejecting the key format.
      - name: Generate appcast
        run: |
          echo "Generating appcast (unsigned)..."
          VERSION="${{ steps.version.outputs.version }}"
          ZIP_SIZE=$(stat -f%z "build/GitBar-v${VERSION}.zip")

          cat > build/appcast.xml << APPCAST_EOF
          <?xml version="1.0" encoding="utf-8"?>
          <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle">
            <channel>
              <title>GitBar Updates</title>
              <link>https://github.com/${{ github.repository }}</link>
              <description>Most recent updates to GitBar</description>
              <language>en</language>
              <item>
                <title>Version ${VERSION}</title>
                <sparkle:version>${VERSION}</sparkle:version>
                <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>
                <pubDate>$(date -R)</pubDate>
                <enclosure
                  url="https://github.com/${{ github.repository }}/releases/download/v${VERSION}/GitBar-v${VERSION}.zip"
                  length="${ZIP_SIZE}"
                  type="application/octet-stream"/>
              </item>
            </channel>
          </rss>
          APPCAST_EOF

          echo "Appcast created at build/appcast.xml"

      - name: Commit updated appcast
        run: |
          # Copy generated appcast to repository root
          cp build/appcast.xml appcast.xml

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Commit and push appcast
          git add appcast.xml
          git diff --staged --quiet || git commit -m "Update appcast.xml for ${{ steps.version.outputs.tag }}"
          git push origin HEAD:main

      - name: Create release notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cat > release_notes.md << 'EOF'
          ## GitBar v${{ steps.version.outputs.version }}

          ### Installation

          **Option 1: Homebrew (Recommended)**
          ```bash
          brew install --cask burhanusman/gitbar/gitbar
          ```

          **Option 2: Download DMG**
          - Download `GitBar-v${{ steps.version.outputs.version }}.dmg`
          - Open the DMG and drag GitBar to Applications folder
          - On first launch, right-click â†’ Open (see note below)

          **Option 3: Direct Download**
          - Download `GitBar-v${{ steps.version.outputs.version }}.zip`
          - Extract and move to Applications folder

          ### âš ï¸ Gatekeeper Note

          This release is code-signed but not yet notarized with Apple. On first launch, macOS may show a security warning. To open:
          1. Right-click (or Control-click) on GitBar.app
          2. Select "Open" from the context menu
          3. Click "Open" in the dialog

          You only need to do this once. Notarization will be added in a future release.

          ### Auto-Updates

          GitBar includes Sparkle for automatic updates. The app will check for updates automatically and notify you when new versions are available.

          ### System Requirements

          - macOS 13.0 (Ventura) or later
          - Apple Silicon or Intel processor

          ---

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ steps.version.outputs.version }}
          EOF

          echo "Release notes created"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            build/GitBar-v${{ steps.version.outputs.version }}.dmg
            build/GitBar-v${{ steps.version.outputs.version }}.zip
            appcast.xml
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.tag, 'beta') || contains(steps.version.outputs.tag, 'alpha') || contains(steps.version.outputs.tag, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # TODO: Auto-update Homebrew tap requires a PAT with repo access
      # GITHUB_TOKEN only has access to the current repo, not homebrew-gitbar
      # For now, output the SHA256 for manual update
      - name: Output Homebrew tap info
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DMG_PATH="build/GitBar-v${VERSION}.dmg"
          SHA256=$(shasum -a 256 "$DMG_PATH" | cut -d' ' -f1)

          echo "## Homebrew Tap Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To update burhanusman/homebrew-gitbar, use:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "version \"$VERSION\"" >> $GITHUB_STEP_SUMMARY
          echo "sha256 \"$SHA256\"" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: |
          # Clean up temporary keychain
          security delete-keychain temp.keychain || true
          # TODO: Re-enable when notarization is restored
          # rm -f /tmp/api-key.p8 || true

      - name: Release summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "## âœ… Release ${{ steps.version.outputs.tag }} Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Created:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ GitBar-v${VERSION}.dmg ($(du -h build/GitBar-v${VERSION}.dmg | cut -f1))" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ GitBar-v${VERSION}.zip ($(du -h build/GitBar-v${VERSION}.zip | cut -f1))" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ appcast.xml (updated)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Built and archived" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code signed (Developer ID)" >> $GITHUB_STEP_SUMMARY
          echo "- â­ï¸ Notarization skipped (TODO: fix CI timeout)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… DMG created and signed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Appcast generated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub Release published" >> $GITHUB_STEP_SUMMARY
          echo "- âš ï¸ Homebrew tap needs manual update (see above)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Note: App is signed but not notarized. Users may need to right-click â†’ Open on first launch." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }})" >> $GITHUB_STEP_SUMMARY

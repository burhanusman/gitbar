name: Release GitBar

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/v}
          echo "version=$TAG" >> $GITHUB_OUTPUT
          echo "tag=$GITHUB_REF_NAME" >> $GITHUB_OUTPUT

      - name: Update Info.plist version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" GitBar/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $VERSION" GitBar/Info.plist
          echo "Updated Info.plist to version $VERSION"

      - name: Import signing certificate
        env:
          CERTIFICATE_BASE64: ${{ secrets.CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        run: |
          echo "Importing Developer ID certificate..."
          echo "$CERTIFICATE_BASE64" | base64 --decode > certificate.p12

          # Create temporary keychain
          security create-keychain -p actions temp.keychain
          security default-keychain -s temp.keychain
          security unlock-keychain -p actions temp.keychain
          security set-keychain-settings -lut 21600 temp.keychain

          # Import certificate
          security import certificate.p12 -k temp.keychain \
            -P "$CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/productsign

          # Allow codesign to access keychain
          security set-key-partition-list -S apple-tool:,apple: \
            -s -k actions temp.keychain

          # Clean up certificate file
          rm certificate.p12

          # Verify certificate
          security find-identity -v -p codesigning temp.keychain

      - name: Build and archive
        run: |
          xcodebuild -project GitBar.xcodeproj \
            -scheme GitBar \
            -configuration Release \
            -archivePath ./build/GitBar.xcarchive \
            archive

      - name: Create export options
        env:
          TEAM_ID: ${{ secrets.TEAM_ID }}
        run: |
          cat > build/ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>developer-id</string>
              <key>teamID</key>
              <string>${TEAM_ID}</string>
              <key>signingStyle</key>
              <string>automatic</string>
              <key>stripSwiftSymbols</key>
              <true/>
          </dict>
          </plist>
          EOF

      - name: Export signed app
        run: |
          xcodebuild -exportArchive \
            -archivePath ./build/GitBar.xcarchive \
            -exportPath ./build \
            -exportOptionsPlist ./build/ExportOptions.plist

      - name: Verify code signature
        run: |
          echo "Verifying code signature..."
          codesign --verify --deep --strict --verbose=2 ./build/GitBar.app
          codesign -dv --verbose=4 ./build/GitBar.app

      - name: Store notarization credentials
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          TEAM_ID: ${{ secrets.TEAM_ID }}
        run: |
          echo "Storing notarization credentials..."
          xcrun notarytool store-credentials "gitbar-notarytool" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --team-id "$TEAM_ID"

      - name: Notarize app bundle
        run: |
          echo "Creating zip for notarization..."
          cd build
          zip -r GitBar-notarize.zip GitBar.app

          echo "Submitting for notarization..."
          xcrun notarytool submit GitBar-notarize.zip \
            --keychain-profile "gitbar-notarytool" \
            --wait

          echo "Stapling notarization ticket..."
          xcrun stapler staple GitBar.app

          echo "Verifying notarization..."
          spctl --assess --verbose=4 --type execute GitBar.app

          rm GitBar-notarize.zip

      - name: Install create-dmg
        run: |
          brew install create-dmg

      - name: Create DMG
        run: |
          chmod +x scripts/create-dmg.sh
          ./scripts/create-dmg.sh build/GitBar.app build

      - name: Sign and notarize DMG
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DMG_PATH="build/GitBar-v${VERSION}.dmg"

          echo "Signing DMG..."
          codesign --sign "Developer ID Application" --timestamp "$DMG_PATH"

          echo "Creating zip of DMG for notarization..."
          cd build
          zip GitBar-dmg-notarize.zip "GitBar-v${VERSION}.dmg"

          echo "Submitting DMG for notarization..."
          xcrun notarytool submit GitBar-dmg-notarize.zip \
            --keychain-profile "gitbar-notarytool" \
            --wait

          echo "Stapling notarization ticket to DMG..."
          xcrun stapler staple "GitBar-v${VERSION}.dmg"

          rm GitBar-dmg-notarize.zip

      - name: Download Sparkle tools
        run: |
          echo "Downloading Sparkle..."
          curl -L -o Sparkle.tar.xz \
            https://github.com/sparkle-project/Sparkle/releases/download/2.6.4/Sparkle-2.6.4.tar.xz
          tar -xf Sparkle.tar.xz
          chmod +x bin/generate_appcast

      - name: Create distribution archive for Sparkle
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd build
          # Create zip from the notarized app
          zip -r GitBar.zip GitBar.app
          mv GitBar.zip "GitBar-v${VERSION}.zip"

      - name: Generate appcast
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          echo "Generating appcast with Sparkle signatures..."
          echo "$SPARKLE_PRIVATE_KEY" > private_key
          chmod 600 private_key

          VERSION="${{ steps.version.outputs.version }}"

          # Generate appcast entry for this version
          ./bin/generate_appcast \
            --ed-key-file private_key \
            --download-url-prefix "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/" \
            build/

          # Clean up private key
          rm private_key

          # The generated appcast will be in build/appcast.xml

      - name: Commit updated appcast
        run: |
          # Copy generated appcast to repository root
          cp build/appcast.xml appcast.xml

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Commit and push appcast
          git add appcast.xml
          git diff --staged --quiet || git commit -m "Update appcast.xml for ${{ steps.version.outputs.tag }}"
          git push origin HEAD:main

      - name: Create release notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cat > release_notes.md << 'EOF'
          ## GitBar v${{ steps.version.outputs.version }}

          ### Installation

          **Option 1: Download DMG (Recommended)**
          - Download `GitBar-v${{ steps.version.outputs.version }}.dmg`
          - Open the DMG and drag GitBar to Applications folder
          - Launch from Applications

          **Option 2: Homebrew Cask**
          ```bash
          brew install --cask gitbar
          ```

          **Option 3: Direct Download**
          - Download `GitBar-v${{ steps.version.outputs.version }}.zip`
          - Extract and move to Applications folder

          ### Auto-Updates

          GitBar includes Sparkle for automatic updates. The app will check for updates automatically and notify you when new versions are available.

          ### System Requirements

          - macOS 13.0 (Ventura) or later
          - Apple Silicon or Intel processor

          ---

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ steps.version.outputs.version }}
          EOF

          echo "Release notes created"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            build/GitBar-v${{ steps.version.outputs.version }}.dmg
            build/GitBar-v${{ steps.version.outputs.version }}.zip
            appcast.xml
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.tag, 'beta') || contains(steps.version.outputs.tag, 'alpha') || contains(steps.version.outputs.tag, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain temp.keychain || true

      - name: Release summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "## âœ… Release ${{ steps.version.outputs.tag }} Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Created:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ GitBar-v${VERSION}.dmg ($(du -h build/GitBar-v${VERSION}.dmg | cut -f1))" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ GitBar-v${VERSION}.zip ($(du -h build/GitBar-v${VERSION}.zip | cut -f1))" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ appcast.xml (updated)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Built and archived" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code signed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Notarized (app + DMG)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… DMG created and signed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Appcast generated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub Release published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }})" >> $GITHUB_STEP_SUMMARY
